{% extends "base.html" %} {% block title %}Application{% endblock title %}
<div>{% block content %}</div>
<!-- <h1>{{ selected_app }}</h1> -->
{{ selected_app|json_script:"app-data" }}
<div
  class="flex-grow p-6"
  id="practice-container"
  data-current-app="{{ selected_app.id }}"
>
  <div class="flex items-center space-x-4 mb-4 ml-8">
    <h1 style="color: #2c2c2c; font-size: 20px" class="font-semibold">
      Interview Practice üí¨
    </h1>

    <div class="form-control">
      <label for="application-select" class="sr-only">Select Application</label>
      <select
        id="application-select"
        name="application_id"
        class="select select-bordered"
      >
        {% for app in apps %}
        <option value="{{ app.id }}">{{ app.desired_role }}</option>
        {% endfor %}
      </select>
    </div>
    <form
      method="POST"
      action="{% url 'application_read' selected_app.id %}"
      onsubmit="return confirm('Are you sure you want to delete this application?');"
    >
      {% csrf_token %}
      <button type="submit" name="delete" value="true">üóëÔ∏è</button>
    </form>
  </div>

  <div class="flex space-x-6">
    <!-- Left column: question list -->
    <div
      class="w-2/5 space-y-2 bg-white p-4 rounded-lg shadow-md overflow-y-auto"
      style="height: 74vh"
    >
      {% for q in selected_app.practice_records %}
      <div tabindex="0" class="collapse border rounded-lg bg-white">
        <input
          type="radio"
          name="question_id"
          class="peer"
          id="q{{ q.id }}"
          value="{{ q.id }}"
        />
        <label
          for="q{{ q.id }}"
          class="collapse-title inline-flex items-baseline space-x-1 peer-checked:bg-[#C9E6F0] cursor-pointer"
        >
          <!-- icon always inline‚Äêblock, aligned baseline -->
          <span class="score-icon inline-block align-baseline">
            {% if q.is_scored %} ‚úÖ {% else %}
            <span
              class="inline-block align-baseline"
              style="width: 14px; height: 14px; border: 1px dashed #ccc"
            ></span>
            {% endif %}
          </span>

          <!-- question text right next to it, same line -->
          <span class="inline-block align-baseline">
            Q{{ q.batch_number }}. {{ q.question_text }}
          </span>
        </label>
      </div>
      {% empty %}
      <p class="text-center text-gray-500">No questions found.</p>
      {% endfor %}
    </div>

    <!-- Right column: detail + answer form -->
    <div
      class="w-3/5 bg-white p-6 rounded-lg shadow-md overflow-y-auto"
      style="height: 74vh"
    >
      <h3 id="detail-title" class="text-l font-semibold mb-4">
        <!-- will be replaced by JS -->
      </h3>
      <div
        id="detail-score"
        class="mb-4 text-sm font-medium text-gray-700"
      ></div>
      <div
        id="tips-container"
        class="alert mb-4 hidden flex flex-col items-start text-left"
      >
        <p class="font-medium">üîç Tips from InterPrep</p>
        <p id="detail-tips" class="mt-2"></p>
      </div>
      <div id="answer-display" class="mb-4 hidden" style="height: 30vh">
        <label class="label"><span class="label-text">Your Answer</span></label>
        <pre
          style="height: 30vh"
          class="whitespace-pre-wrap border p-4 rounded overflow-y-auto"
        >
{{ "" }}</pre
        >
        <button id="edit-btn" type="button" class="btn btn-sm mt-2">
          Edit Answer
        </button>
        <button
          id="submit-btn"
          type="button"
          class="btn btn-sm btn-outline mt-2 ml-2"
        >
          Submit
        </button>
      </div>
      <form id="answer-form" class="hidden">
        {% csrf_token %}
        <label class="label"><span class="label-text">Your Answer</span></label>
        <textarea
          id="detail-answer"
          name="answer_text"
          class="textarea textarea-bordered w-full h-48 mb-4"
          placeholder="Type your answer here‚Ä¶"
        ></textarea>
        <button type="button" id="save-btn" class="btn btn-sm">
          Save Answer
        </button>
      </form>
    </div>
  </div>
</div>
<div
  id="loading"
  class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center hidden"
>
  <span class="loading loading-spinner text-success"></span>
</div>

<script>
  const saveUrlTemplate = "{% url 'practice' %}";
  const submitUrlTemplate = "{% url 'submit' %}";

  document.addEventListener("DOMContentLoaded", () => {
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        document.cookie.split(";").forEach((cookie) => {
          const [key, val] = cookie.trim().split("=");
          if (key === name) {
            cookieValue = decodeURIComponent(val);
          }
        });
      }
      return cookieValue;
    }

    // 1) Application dropdown handling
    const container = document.getElementById("practice-container");
    const currentApp = container.dataset.currentApp;
    const appSelect = document.getElementById("application-select");
    appSelect.value = currentApp;
    appSelect.addEventListener("change", () => {
      const newId = appSelect.value;
      window.location.href = "{% url 'application_read' 0 %}".replace(
        /0$/,
        newId
      );
    });

    // 2) Parse embedded JSON and build a lookup map
    const appData = JSON.parse(document.getElementById("app-data").textContent);
    const records = {};
    appData.practice_records.forEach((r) => {
      records[r.id] = r;
    });

    // 3) Cache detail‚Äêpane DOM nodes
    const detailTitle = document.getElementById("detail-title");
    const tipsContainer = document.getElementById("tips-container");
    const detailTips = document.getElementById("detail-tips");
    const detailScore = document.getElementById("detail-score");
    const answerDisplay = document.getElementById("answer-display");
    const answerForm = document.getElementById("answer-form");
    const detailAnswer = document.getElementById("detail-answer");
    const editBtn = document.getElementById("edit-btn");
    const saveBtn = document.getElementById("save-btn");
    const submitBtn = document.getElementById("submit-btn");

    // 4) Helpers to show/hide tips box
    function updateTips(rec) {
      if (rec.is_scored) {
        tipsContainer.classList.remove("hidden");
        detailTips.textContent = rec.feedback || "";
      } else {
        tipsContainer.classList.add("hidden");
        detailTips.textContent = "";
      }
    }

    // 5) Helpers to switch between display vs. edit form
    function showDisplay(rec) {
      detailAnswer.value = rec.answer_text || "";
      answerDisplay.querySelector("pre").textContent = rec.answer_text || "";
      answerForm.classList.add("hidden");
      answerDisplay.classList.remove("hidden");
    }

    function showForm(rec) {
      detailAnswer.value = rec.answer_text || "";
      answerDisplay.classList.add("hidden");
      answerForm.classList.remove("hidden");
    }
    function showRecord(rec) {
      detailTitle.textContent = `Q${rec.batch_number}. ${rec.question_text}`;

      detailScore.textContent =
        rec.score != null ? `‚≠ê Score: ${rec.score}/100` : `‚è≥ Not scored yet`;

      if (rec.is_scored) {
        tipsContainer.classList.remove("hidden");
        detailTips.textContent = rec.feedback || "";
      } else {
        tipsContainer.classList.add("hidden");
      }

      if (rec.answer_text) {
        showDisplay(rec);
      } else {
        showForm(rec);
      }
    }
    // 6) When a question radio changes, populate detail pane
    document.querySelectorAll("input[name='question_id']").forEach((radio) => {
      radio.addEventListener("change", () => {
        if (!radio.checked) return;
        const rec = records[radio.value];
        if (rec) showRecord(rec);
      });
    });

    // 7) Edit button switches to form mode
    editBtn.addEventListener("click", () => {
      const checked = document.querySelector(
        "input[name='question_id']:checked"
      );
      if (!checked) return;
      const rec = records[checked.value];
      showForm(rec);
    });

    saveBtn.addEventListener("click", async () => {
      const checked = document.querySelector(
        "input[name='question_id']:checked"
      );
      if (!checked) return alert("Please select a question first.");
      const qid = checked.value;

      // 3) Grab the answer text
      const text = detailAnswer.value.trim();
      if (!text) return alert("Answer cannot be blank.");

      try {
        // 4) Send the POST to your AnswerUpdateDeleteView
        const res = await fetch(saveUrlTemplate, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
            Accept: "application/json",
          },
          body: JSON.stringify({ answer_text: text, question_id: qid }),
        });

        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || "Save failed");
        }

        // 5) Get the updated record back
        const updated = await res.json();

        // 6) Update your in-page data and UI
        records[qid] = updated;
        showDisplay(updated);
        updateTips(updated);
      } catch (e) {
        alert(e.message);
      }
    });

    submitBtn.addEventListener("click", async () => {
      document.getElementById("loading").classList.remove("hidden");
      const checked = document.querySelector(
        "input[name='question_id']:checked"
      );
      if (!checked) return alert("Please select a question first.");
      const qid = checked.value;
      const rec = records[qid];
      const text = detailAnswer.value.trim();
      if (!text) return alert("Answer cannot be blank.");
      try {
        const res = await fetch(submitUrlTemplate, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
            Accept: "application/json",
          },
          body: JSON.stringify({ answer_text: text, question_id: qid }),
        });

        if (!res.ok) throw new Error("Submit failed");
        document.getElementById("loading").classList.add("hidden");
        const updated = await res.json();
        records[qid] = updated;
        showRecord(updated);
        showDisplay(updated);
        updateTips(updated);
        const radio = document.querySelector(
          `input[name="question_id"][value="${qid}"]`
        );
        if (radio) {
          const titleLabel = radio.nextElementSibling; // input ‚Üí label
          const iconSpan = titleLabel.querySelector(".score-icon");
          if (updated.is_scored) {
            iconSpan.textContent = "‚úÖ";
          } else {
            iconSpan.innerHTML = `<span style="width:14px;height:14px;border:1px dashed #ccc;display:inline-block"></span>`;
          }
        }
      } catch (err) {
        alert(err.message);
      }
    });

    // 8) Initialize on first question
    const firstRadio = document.querySelector("input[name='question_id']");
    if (firstRadio) {
      firstRadio.checked = true;
      firstRadio.dispatchEvent(new Event("change"));
    }
  });
</script>

{% endblock %}
